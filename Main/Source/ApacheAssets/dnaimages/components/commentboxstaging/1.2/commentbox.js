var dna=dna||{};dna.lang={g:window.glow||false,$:(window.glow)?glow.dom.get:false,register:function(a){dna.error.lang(a);dna.utils.lang(a);dna.comments.lang(a);dna.comments.processQueue()}};dna.error=function(){var c=dna.lang.g,e=dna.lang.$;var a={500:"We are currently experiencing problems accepting ",404:"Could not send your comment, please check your Internet Connection.",404:"Could not send your comment, please check your Internet Connection.",couldNotSendComment:"There was a problem sending your comment, please try again.",XmlParseError:"You comment included invalid HTML and could not be added. Please try entering your message again.",profanityblocked:"Your comment was failed by the profanity filter.",invalidcomment:"Type your comment into the text area and then press 'Post Comment'.",unknown:"There has been an unexpected problem. Please reload the page and try again."};function d(i){var g=i.status||i.error.errorType;if(g=="XmlParseError"){f("Your comment contains some HTML that has been mistyped.",i.error.errorMessage)}else{if(a[g]){b(a[g])}else{b(a.unknown)}}}function f(k,j){var l={helper:k,message:j},g=e("#dna-error"),i='<h4>There has been a problem...</h4><p>{helper}</p><p class="error-message">{message}</p>';if(!g[0]){g=c.dom.create('<div id="dna-error" class="error"></div>').insertAfter(c.dom.get("#dna-commentbox-submit").parent())}g.html(c.lang.interpolate(i,l))}function b(g){alert(g)}function h(g){c=g;e=g.dom.get}return{notify:b,handle:d,lang:h}}();dna.utils=function(){var f=dna.lang.g,e=dna.lang.$;function j(g){return g.replace(/(\n|\r|\t|\s\s)/gi,"")}function c(g){return g.replace(/(\n|\r)/gi,"<br />")}function k(){var g="";var q={};if(g=window.location.search){var p=g.substring(1).split("&");var n=[];for(var o=0,m=p.length;o<m;o++){n=p[o].split("=");q[n[0]]=n[1]}}return q}function a(l,g,m){var g=window.open(l,"name","status=1,resizable=1,scrollbars=1,height="+m+",width="+g);if(window.focus){g.focus()}return false}var b={get:function(){var o=document.cookie.split(";");var p={};if(o){var n=[];for(var m=0,g=o.length;m<g;m++){n=o[m].split("=");p[n[0]]=n[1]}}return p},set:function(m,n,l,o){var g="";if(l){var p=new Date();p.setTime(p.getTime()+(l*24*60*60*1000));var g="; expires="+p.toGMTString()}if(!o){o=window.location.pathname}document.cookie=m+"="+n+g+"; path="+o;if(dna.utils.cookie.get()[m]==n){return true}else{return false}}};function i(g,m){if(f.env.gecko){var l=new RegExp("(\\S){"+m+",}","gmi");e(g).each(function(p){var q=l.exec(this.text);if(q){for(var p=0,n=q.length;p<n;p++){if(q[p].length>=m){var o=q[p].slice(0,m)+"<br />"+q[p].slice(m,q[p].length);this.text=this.text.replace(q[p],o)}}}})}}function h(m){var g=/\s&\s/gi;var l=m.replace(g," &amp; ");return l}function d(g){f=g;e=g.dom.get}return{cleanWhitespace:j,newlineToBr:c,getQuerystring:k,popup:a,wrapText:i,cookie:b,tagSoupToXml:h,lang:d}}();dna.comments=function(){var t=dna.lang.g,b=dna.lang.$;var u="/dnaimages/components/shared",h="",c="",d=false,s=false,k=false,o=false;function r(w){d=glow.dom.get(w);if(d[0]){s=b("#dna-commentbox-text");k=b("#dna-commentbox-submit");m.addButton();var g=d[0].action;d[0].action=g.replace(/\/comments\/acs/,"/json/acs");t.events.addListener(d,"submit",function(x){l.disable();e.add();p.send();return false})}}function f(){var g=dna.utils.getQuerystring();if(g.dnaerrortype){dna.error.handle(g.dnaerrortype)}i.check()}var l={disable:function(){k.addClass("disabled");k[0].disabled=true;k[0].blur();previewEl.addClass("disabled");previewEl[0].disabled=true;s.addClass("disabled");s[0].disabled=true},enable:function(){k.removeClass("disabled");k[0].disabled=false;previewEl.removeClass("disabled");previewEl[0].disabled=false;s.removeClass("disabled");s[0].disabled=false},resetCommentText:function(){s[0].value=""}};var e={add:function(){t.dom.create('<img src="'+u+'/img/loader-paleblue.gif" id="dna-commentbox-loader" />').insertAfter(k)},remove:function(){b("#dna-commentbox-loader").remove()}};var i={timer:false,check:function(){var g=dna.utils.cookie.get().dnaCountdown;if(g>0){i.start(g)}},start:function(A){var z=new Date();var y=z.getTime();var B=(A*1000);var g=y+B;dna.utils.cookie.set("dnaCountdown",A,1);var w=function(){dna.utils.cookie.set("dnaCountdown",--A,1);if(i.onUpdate){i.onUpdate(A)}};w();var x=function(){if(new Date().getTime()>g){i.stop();dna.utils.cookie.set("dnaCountdown","",-1)}else{w()}};i.timer=setInterval(x,1000)},stop:function(){clearInterval(i.timer);if(i.onStop){i.onStop()}},onUpdate:function(g){var w=b("#dna-commentbox-countdown");if(!w[0]){t.dom.create('<span id="dna-commentbox-countdown">Post successful.</span>').insertAfter(k);w=b("#dna-commentbox-countdown")}w[0].innerHTML="You must wait "+g+" seconds until you can make another comment."},onStop:function(){b("#dna-commentbox-countdown").empty();l.enable()}};var p={send:function(){var g=d[0].action,w=dna.utils.tagSoupToXml(s[0].value);t.net.post(g,{dnacomment:w,dnauid:d.children().children().filter(function(){return this.name=="dnauid"})[0].value,dnaaction:"add",dnaur:0,dnapoststyle:1,s_xhr:1},{onLoad:p.processResponse,onError:p.onError})},processResponse:function(g){var w=t.data.decodeJson(dna.utils.cleanWhitespace(g.text()),{safeMode:false});if(w.error.errorType){p.onError(w)}else{if(b("#comment"+w.id)[0]){e.remove();dna.error.notify("You already said that in comment "+w.id);i.stop()}else{q(w);if(p.onSuccess){p.onSuccess()}}}},onError:function(g){e.remove();i.stop();l.enable();dna.error.handle(g)},onSuccess:function(){e.remove();i.start(i.seconds||defaultCountdown)}};function q(w){var g;m.remove();noCommentsEl=d.parent().get("p.dna-commentbox-nocomments");if(noCommentsEl[0]){g=t.dom.create('<ul class="collections forumthreadposts"></ul>').insertBefore(noCommentsEl);noCommentsEl.remove()}else{g=d.parent().get("ul.forumthreadposts").sort().slice(0,1)}t.dom.create(w.html).addClass((g.children().length%2)?"stripe":"").appendTo(g);l.resetCommentText()}var m={addButton:function(){t.dom.create('<input type="button" id="dna-commentbox-preview" value="Preview"/>').insertBefore(k);previewEl=b("#dna-commentbox-preview");t.events.addListener(previewEl,"click",m.generate)},generate:function(){var x=b("#dna-commentbox-previewArea");if(!x[0]){t.dom.create('<ul class="collections forumthreadposts" id="dna-commentbox-previewArea"></ul>').insertAfter(d);previewAreaEl=x=b("#dna-commentbox-previewArea")}var w=new Date();var y=w.toString().split(" ")[1];var z={text:dna.utils.newlineToBr(s[0].value),viewingUserGroup:c,name:h,count:previewAreaEl.prev().prev().prev().get("li").length+1,time:w.getHours()+":"+((w.getMinutes()<10)?"0":"")+w.getMinutes()+" "+((w.getHours()<12)?"am":"pm"),date:w.getDate()+" "+y+" "+w.getFullYear()};var g='<li class="{viewingUserGroup}"><span class="comment-number">{count}. </span><cite>At <a href="#postcomment" class="time">{time}</a> on <span class="date">{date}</span>, <span class="vcard"><span class="fn"><a href="#dna-commentbox-previewArea">{name}</a></span></span> wrote:</cite><p class="comment-text">{text}</p><p class="flag"></p></li>';x[0].innerHTML=t.lang.interpolate(g,z)},remove:function(){b("#dna-commentbox-previewArea").remove()}};var j=[];function n(g){if(g.targetForm){j[j.length]=g}else{throw new Error("DNA Comments: A target form is a required parameter.")}}function a(){if(j.length>0){for(var w=0,g=j.length;w<g;w++){dna.comments.apply(j[w])}}}function v(g){t=g;b=g.dom.get}return{apply:function(g){if(g.targetForm){defaultCountdown=20;h=g.viewingUser;c=g.viewingUserGroup;glow.dom.get(".popup").each(function(){t.events.addListener(this,"click",function(){dna.utils.popup(this.href,694,546);return false})});r(g.targetForm);f();dna.utils.wrapText("#comments p.comment-text",65)}else{throw new Error("DNA Comments: A target form is a required parameter.")}},ui:{disable:l.disable,enable:l.enable},countdown:{onUpdate:i.onUpdate,onStop:i.onStop},loader:{add:e.add,remove:e.remove},post:{send:p.send,onError:p.onError,processResponse:p.processResponse,onSuccess:p.onSuccess},preview:{generate:m.generate,remove:m.remove},updateDom:q,queue:n,processQueue:a,lang:v}}();