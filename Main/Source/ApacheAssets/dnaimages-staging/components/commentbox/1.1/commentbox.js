var dna=dna||{};dna.lang={g:window.glow||false,$:(window.glow)?glow.dom.get:false,register:function(A){dna.error.lang(A);dna.utils.lang(A);dna.comments.lang(A);dna.comments.processQueue()}};dna.error=function(){var C=dna.lang.g,E=dna.lang.$;var A={500:"We are currently experiencing problems accepting ",404:"Could not send your comment, please check your Internet Connection.",404:"Could not send your comment, please check your Internet Connection.",couldNotSendComment:"There was a problem sending your comment, please try again.",XmlParseError:"You comment included invalid HTML and could not be added. Please try entering your message again.",profanityblocked:"Your comment was failed by the profanity filter.",invalidcomment:"Type your comment into the text area and then press 'Post Comment'.",unknown:"There has been an unexpected problem. Please reload the page and try again."};function D(I){var H=I.status||I.error.errorType;if(H=="XmlParseError"){F("Your comment contains some HTML that has been mistyped.",I.error.errorMessage)}else{if(A[H]){B(A[H])}else{B(A.unknown)}}}function F(K,J){var L={helper:K,message:J},H=E("#dna-error"),I='<h4>There has been a problem...</h4><p>{helper}</p><p class="error-message">{message}</p>';if(!H[0]){H=C.dom.create('<div id="dna-error" class="error"></div>').insertAfter(C.dom.get("#dna-commentbox-submit").parent())}H.html(C.lang.interpolate(I,L))}function B(H){alert(H)}function G(H){C=H;E=H.dom.get}return{notify:B,handle:D,lang:G}}();dna.utils=function(){var F=dna.lang.g,E=dna.lang.$;function I(K){return K.replace(/(\n|\r|\t|\s\s)/gi,"")}function C(K){return K.replace(/(\n|\r)/gi,"<br />")}function J(){var K="";var P={};if(K=window.location.search){var O=K.substring(1).split("&");var M=[];for(var N=0,L=O.length;N<L;N++){M=O[N].split("=");P[M[0]]=M[1]}}return P}function A(L,K,M){var K=window.open(L,"name","status=1,resizable=1,scrollbars=1,height="+M+",width="+K);if(window.focus){K.focus()}return false}var B={get:function(){var N=document.cookie.split(";");var O={};if(N){var M=[];for(var L=0,K=N.length;L<K;L++){M=N[L].split("=");O[M[0]]=M[1]}}return O},set:function(M,N,L,O){var K="";if(L){var P=new Date();P.setTime(P.getTime()+(L*24*60*60*1000));var K="; expires="+P.toGMTString()}if(!O){O=window.location.pathname}document.cookie=M+"="+N+K+"; path="+O;if(dna.utils.cookie.get()[M]==N){return true}else{return false}}};function H(K,M){if(F.env.gecko){var L=new RegExp("(\\S){"+M+",}","gmi");E(K).each(function(P){var Q=L.exec(this.text);if(Q){for(var P=0,N=Q.length;P<N;P++){if(Q[P].length>=M){var O=Q[P].slice(0,M)+"<br />"+Q[P].slice(M,Q[P].length);this.text=this.text.replace(Q[P],O)}}}})}}function G(M){var K=/\s&\s/gi;var L=M.replace(K," &amp; ");return L}function D(K){F=K;E=K.dom.get}return{cleanWhitespace:I,newlineToBr:C,getQuerystring:J,popup:A,wrapText:H,cookie:B,tagSoupToXml:G,lang:D}}();dna.comments=function(){var S=dna.lang.g,B=dna.lang.$;var T="/dnaimages/components/shared",G="",C="",D=false,R=false,J=false,N=false;function Q(W){D=B(W);if(D[0]){R=B("#dna-commentbox-text");J=B("#dna-commentbox-submit");L.addButton();var V=D[0].action;D[0].action=V.replace(/\/comments\/acs/,"/json/acs");S.events.addListener(D,"submit",function(X){K.disable();E.add();O.send();return false})}}function F(){var V=dna.utils.getQuerystring();if(V.dnaerrortype){dna.error.handle(V.dnaerrortype)}H.check()}var K={disable:function(){J.addClass("disabled");J[0].disabled=true;J[0].blur();previewEl.addClass("disabled");previewEl[0].disabled=true;R.addClass("disabled");R[0].disabled=true},enable:function(){J.removeClass("disabled");J[0].disabled=false;previewEl.removeClass("disabled");previewEl[0].disabled=false;R.removeClass("disabled");R[0].disabled=false},resetCommentText:function(){R[0].value=""}};var E={add:function(){S.dom.create('<img src="'+T+'/img/loader-paleblue.gif" id="dna-commentbox-loader" />').insertAfter(J)},remove:function(){B("#dna-commentbox-loader").remove()}};var H={timer:false,check:function(){var V=dna.utils.cookie.get().dnaCountdown;if(V>0){H.start(V)}},start:function(a){var Z=new Date();var Y=Z.getTime();var b=(a*1000);var V=Y+b;dna.utils.cookie.set("dnaCountdown",a,1);var W=function(){dna.utils.cookie.set("dnaCountdown",--a,1);if(H.onUpdate){H.onUpdate(a)}};W();var X=function(){if(new Date().getTime()>V){H.stop();dna.utils.cookie.set("dnaCountdown","",-1)}else{W()}};H.timer=setInterval(X,1000)},stop:function(){clearInterval(H.timer);if(H.onStop){H.onStop()}},onUpdate:function(V){var W=B("#dna-commentbox-countdown");if(!W[0]){S.dom.create('<span id="dna-commentbox-countdown">Post successful.</span>').insertAfter(J);W=B("#dna-commentbox-countdown")}W[0].innerHTML="You must wait "+V+" seconds until you can make another comment."},onStop:function(){B("#dna-commentbox-countdown").empty();K.enable()}};var O={send:function(){var V=D[0].action,W=dna.utils.tagSoupToXml(R[0].value);S.net.post(V,{dnacomment:W,dnauid:D.children().children().filter(function(){return this.name=="dnauid"})[0].value,dnaaction:"add",dnaur:0,dnapoststyle:1,s_xhr:1},{onLoad:O.processResponse,onError:O.onError})},processResponse:function(V){var W=S.data.decodeJson(dna.utils.cleanWhitespace(V.text()),{safeMode:false});if(W.error.errorType){O.onError(W)}else{if(B("#comment"+W.id)[0]){E.remove();dna.error.notify("You already said that in comment "+W.id);H.stop()}else{P(W);if(O.onSuccess){O.onSuccess()}}}},onError:function(V){E.remove();H.stop();K.enable();dna.error.handle(V)},onSuccess:function(){E.remove();H.start(H.seconds||defaultCountdown)}};function P(W){var V;L.remove();noCommentsEl=D.parent().get("p.dna-commentbox-nocomments");if(noCommentsEl[0]){V=S.dom.create('<ul class="collections forumthreadposts"></ul>').insertBefore(noCommentsEl);noCommentsEl.remove()}else{V=D.parent().get("ul.forumthreadposts").sort().slice(0,1)}S.dom.create(W.html).addClass((V.children().length%2)?"stripe":"").appendTo(V);K.resetCommentText()}var L={addButton:function(){S.dom.create('<input type="button" id="dna-commentbox-preview" value="Preview"/>').insertBefore(J);previewEl=B("#dna-commentbox-preview");S.events.addListener(previewEl,"click",L.generate)},generate:function(){var X=B("#dna-commentbox-previewArea");if(!X[0]){S.dom.create('<ul class="collections forumthreadposts" id="dna-commentbox-previewArea"></ul>').insertAfter(D);previewAreaEl=X=B("#dna-commentbox-previewArea")}var W=new Date();var Y=W.toString().split(" ")[1];var Z={text:dna.utils.newlineToBr(R[0].value),viewingUserGroup:C,name:G,count:previewAreaEl.prev().prev().prev().get("li").length+1,time:W.getHours()+":"+((W.getMinutes()<10)?"0":"")+W.getMinutes()+" "+((W.getHours()<12)?"am":"pm"),date:W.getDate()+" "+Y+" "+W.getFullYear()};var V='<li class="{viewingUserGroup}"><span class="comment-number">{count}. </span><cite>At <a href="#postcomment" class="time">{time}</a> on <span class="date">{date}</span>, <span class="vcard"><span class="fn"><a href="#dna-commentbox-previewArea">{name}</a></span></span> wrote:</cite><p class="comment-text">{text}</p><p class="flag"></p></li>';X[0].innerHTML=S.lang.interpolate(V,Z)},remove:function(){B("#dna-commentbox-previewArea").remove()}};var I=[];function M(V){if(V.targetForm){I[I.length]=V}else{throw new Error("DNA Comments: A target form is a required parameter.")}}function A(){if(I.length>0){for(var W=0,V=I.length;W<V;W++){dna.comments.apply(I[W])}}}function U(V){S=V;B=V.dom.get}return{apply:function(V){if(V.targetForm){defaultCountdown=20;G=V.viewingUser;C=V.viewingUserGroup;B(".popup").each(function(){S.events.addListener(this,"click",function(){dna.utils.popup(this.href,694,546);return false})});Q(V.targetForm);F();dna.utils.wrapText("#comments p.comment-text",65)}else{throw new Error("DNA Comments: A target form is a required parameter.")}},ui:{disable:K.disable,enable:K.enable},countdown:{onUpdate:H.onUpdate,onStop:H.onStop},loader:{add:E.add,remove:E.remove},post:{send:O.send,onError:O.onError,processResponse:O.processResponse,onSuccess:O.onSuccess},preview:{generate:L.generate,remove:L.remove},updateDom:P,queue:M,processQueue:A,lang:U}}();