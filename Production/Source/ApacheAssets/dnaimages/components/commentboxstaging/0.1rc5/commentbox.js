var dna=function(){var C=glow;var D=C.dom.get;var B={bank:{500:"We are currently experiencing problems accepting comments.",404:"Could not send your comment, please check your Internet Connection.",couldNotSendComment:"There was a problem sending your comment, please try again.",XmlParseError:"You comment included invalid HTML and could not be added. Please try entering your message again.",profanityblocked:"Your comment was failed by the profanity filter.",invalidcomment:"Type your comment into the text area and then press 'Post Comment'.",unknown:"There has been an unexpected problem. Please reload the page and try again."},handle:function(F){if(B.bank[F]){B.notify(B.bank[F])}else{B.notify(B.bank.unknown)}},notify:function(F){alert(F)}};var A={cleanWhitespace:function(F){return F.replace(/(\n|\r|\t|\s\s)/gi,"")},newlineToBr:function(F){return F.replace(/(\n|\r)/gi,"<br />")},getQuerystring:function(){var F="";var K={};if(F=window.location.search){var J=F.substring(1).split("&");var H=[];for(var I=0,G=J.length;I<G;I++){H=J[I].split("=");K[H[0]]=H[1]}}return K},popup:function(G,F,H){var F=window.open(G,"name","status=1,resizable=1,scrollbars=1,height="+H+",width="+F);if(window.focus){F.focus()}return false},cookie:{get:function(){var I=document.cookie.split(";");var J={};if(I){var H=[];for(var G=0,F=I.length;G<F;G++){H=I[G].split("=");J[H[0]]=H[1]}}return J},set:function(H,I,G,J){var F="";if(G){var K=new Date();K.setTime(K.getTime()+(G*24*60*60*1000));var F="; expires="+K.toGMTString()}if(!J){J=window.location.pathname}document.cookie=H+"="+I+F+"; path="+J;if(dna.utils.cookie.get()[H]==I){return true}else{return false}}}};var E={assetPath:"/dnaimages/components/shared",viewingUser:"",viewingUserGroup:"",formEl:false,textEl:false,submitEl:false,noComments:false,AddEvents:function(G){E.formEl=D(G);if(E.formEl[0]){E.textEl=D("#dna-commentbox-text");E.submitEl=D("#dna-commentbox-submit");E.preview.addButton();var F=E.formEl[0].action;E.formEl[0].action=F.replace(/vanilla/,"vanilla-json");C.events.addListener(E.formEl,"submit",function(H){dna.comments.ui.disable();dna.comments.loader.add();dna.comments.post.send();return false})}},cleanUp:function(){var F=A.getQuerystring();if(F.dnaerrortype){dna.error.handle(F.dnaerrortype)}E.countdown.check()},ui:{disable:function(){E.submitEl.addClass("disabled");E.submitEl[0].disabled=true;E.submitEl[0].blur();E.previewEl.addClass("disabled");E.previewEl[0].disabled=true;E.textEl.addClass("disabled");E.textEl[0].disabled=true},enable:function(){E.submitEl.removeClass("disabled");E.submitEl[0].disabled=false;E.previewEl.removeClass("disabled");E.previewEl[0].disabled=false;E.textEl.removeClass("disabled");E.textEl[0].disabled=false},resetCommentText:function(){E.textEl[0].value=""}},loader:{add:function(){C.dom.create('<img src="'+E.assetPath+'/img/loader-paleblue.gif" id="dna-commentbox-loader" />').insertAfter(E.submitEl)},remove:function(){D("#dna-commentbox-loader").remove()}},countdown:{timer:false,check:function(){var F=A.cookie.get().dnaCountdown;if(F>0){E.countdown.start(F)}},start:function(K){var J=new Date();var I=J.getTime();var L=(K*1000);var F=I+L;A.cookie.set("dnaCountdown",K,1);var G=function(){A.cookie.set("dnaCountdown",--K,1);if(dna.comments.countdown.onUpdate){dna.comments.countdown.onUpdate(K)}};G();var H=function(){if(new Date().getTime()>F){E.countdown.stop();A.cookie.set("dnaCountdown","",-1)}else{G()}};E.countdown.timer=setInterval(H,1000)},stop:function(){clearInterval(E.countdown.timer);if(dna.comments.countdown.onStop){dna.comments.countdown.onStop()}},onUpdate:function(F){var G=D("#dna-commentbox-countdown");if(!G[0]){C.dom.create('<span id="dna-commentbox-countdown">Post successful.</span>').insertAfter(E.submitEl);G=D("#dna-commentbox-countdown")}G[0].innerHTML="You must wait "+F+" seconds until you can make another comment."},onStop:function(){D("#dna-commentbox-countdown").empty();dna.comments.ui.enable()}},post:{send:function(){var F=E.formEl[0].action;C.net.post(F,{dnacomment:E.textEl[0].value,dnauid:E.formEl.children().children().filter(function(){return this.name=="dnauid"})[0].value,dnaaction:"add",dnaur:0,dnapoststyle:1,s_xhr:1},{load:dna.comments.post.processResponse,error:dna.comments.post.onError})},processResponse:function(F){var G=glow.data.decodeJson(A.cleanWhitespace(F.text()),{safeMode:false});if(G.error.errorType){dna.comments.post.onError(G)}else{if(D("#comment"+G.id)[0]){dna.comments.loader.remove();dna.error.notify("You already said that in comment "+G.id);E.countdown.stop()}else{dna.comments.updateDom(G);if(dna.comments.post.onSuccess){dna.comments.post.onSuccess()}}}},onError:function(F){dna.comments.loader.remove();E.countdown.stop();dna.comments.ui.enable();dna.error.handle(F.status||F.error.errorType)},onSuccess:function(){dna.comments.loader.remove();E.countdown.start(dna.comments.countdown.seconds||E.defaultCountdown)}},updateDom:function(G){var F;dna.comments.preview.remove();E.noCommentsEl=E.formEl.parent().get("p.dna-commentbox-nocomments");if(E.noCommentsEl[0]){F=C.dom.create('<ul class="collections forumthreadposts"></ul>').insertBefore(E.noCommentsEl);E.noCommentsEl.remove()}else{F=E.formEl.parent().get("ul.forumthreadposts").sort().slice(0,1)}C.dom.create(G.html).addClass((F.children().length%2)?"stripe":"").appendTo(F);E.ui.resetCommentText()},preview:{addButton:function(){C.dom.create('<input type="button" id="dna-commentbox-preview" value="Preview"/>').insertBefore(E.submitEl);E.previewEl=D("#dna-commentbox-preview");C.events.addListener(E.previewEl,"click",dna.comments.preview.generate)},generate:function(){var H=D("#dna-commentbox-previewArea");if(!H[0]){C.dom.create('<ul class="collections forumthreadposts" id="dna-commentbox-previewArea"></ul>').insertAfter(E.formEl);E.previewAreaEl=H=D("#dna-commentbox-previewArea")}var G=new Date();var I=G.toString().split(" ")[1];var J={text:A.newlineToBr(E.textEl[0].value),viewingUserGroup:E.viewingUserGroup,name:E.viewingUser,count:E.previewAreaEl.prev().prev().prev().get("li").length+1,time:G.getHours()+":"+G.getMinutes()+" "+((G.getHours()<12)?"am":"pm"),date:G.getDate()+" "+I+" "+G.getFullYear()};var F='<li class="{viewingUserGroup}"><span class="comment-number">{count}. </span><cite>At <a href="#postcomment" class="time">{time}</a> on <span class="date">{date}</span>, <span class="vcard"><span class="fn"><a href="#">{name}</a></span></span> wrote:</cite><p class="comment-text">{text}</p><p class="flag"></p></li>';H[0].innerHTML=C.lang.interpolate(F,J)},remove:function(){D("#dna-commentbox-previewArea").remove()}}};return{error:B,utils:{cleanWhitespace:A.cleanWhitespace,getQuerystring:A.getQuerystring,popup:A.popup,cookie:A.cookie},comments:{apply:function(F){if(F.targetForm){E.defaultCountdown=F.timeBetweenComments||120;E.viewingUser=F.viewingUser;E.viewingUserGroup=F.viewingUserGroup;D(".popup").each(function(){glow.events.addListener(this,"click",function(){dna.utils.popup(this.href,694,546);return false})});E.AddEvents(F.targetForm);E.cleanUp()}else{throw new Error("DNA Comments: A target form is a required parameter.")}},ui:{disable:E.ui.disable,enable:E.ui.enable},countdown:{onUpdate:E.countdown.onUpdate,onStop:E.countdown.onStop},loader:{add:E.loader.add,remove:E.loader.remove},post:{send:E.post.send,onError:E.post.onError,processResponse:E.post.processResponse,onSuccess:E.post.onSuccess},preview:{generate:E.preview.generate,remove:E.preview.remove},updateDom:E.updateDom}}}();