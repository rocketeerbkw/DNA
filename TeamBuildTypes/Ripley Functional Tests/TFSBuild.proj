<?xml version="1.0" encoding="utf-8"?>
<!-- DO NOT EDIT the project element - the ToolsVersion specified here does not prevent the solutions 
     and projects in the SolutionToBuild item group from targeting other versions of the .NET framework. 
     -->
<Project DefaultTargets="DesktopBuild" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="3.5">

  <!-- Do not edit this -->
  <Import Project="$(MSBuildExtensionsPath)\Microsoft\VisualStudio\TeamBuild\Microsoft.TeamFoundation.Build.targets" />



  <ItemGroup>
    <WebSites Include="$(BinariesRoot)\Debug\_PublishedWebsites\**\*.*"></WebSites>
    <Binaries Include="$(BinariesRoot)\Debug\*.*" Exclude="$(BinariesRoot)$(Platform)$(Configuration)\debug\*_Accessor.dll,$(BinariesRoot)$(Platfom)$(Configuration)\debug\*.instr.pdb"></Binaries>
    <Ripley Include="$(BinariesRoot)\Win32\Debug\*.*"></Ripley>
    <Skins Include="$(SolutionRoot)\Main\Source\Skins\**\*.*" Exclude="$(SolutionRoot)\Main\Source\Skins\base\site.xsl;$(SolutionRoot)\Main\Source\Skins\base\lists.xsl;$(SolutionRoot)\Main\Source\Skins\base\sitemap.xml;$(SolutionRoot)\Main\Source\Skins\common\configuration.xsl" ></Skins>
  </ItemGroup>

  <Target Name="BeforeTest">
    <!-- Create the build steps which start in mode "Running" -->
    <BuildStep TeamFoundationServerUrl="$(TeamFoundationServerUrl)" BuildUri="$(BuildUri)" Message="Deploying build to test server" Condition=" '$(IsDesktopBuild)' != 'true' ">
      <!-- Return the ID of the tasks and assigned it to "PropertyName" -->
      <Output TaskParameter="Id" PropertyName="PostBuildStepId" />
    </BuildStep>

    <!-- stop website to copy ripley -->
    <Exec Command="iisweb /stop h2g2UnitTesting" Timeout="10000"></Exec>

    <Exec Command="net stop &quot;memcached server&quot;" Timeout="10000" ContinueOnError="true"></Exec>

    <Message Text="WebSites files: $(BinariesRoot)\Debug\_PublishedWebsites"></Message>
    <!-- Copy Websites to location -->
    <Copy SourceFiles="@(WebSites)" DestinationFolder="C:\Inetpub\wwwroot\h2g2UnitTesting\dna\%(RecursiveDir)" SkipUnchangedFiles="false"  ContinueOnError="false"/>

    <!-- Copy Dlls into dnapages for tests... -->
    <Copy SourceFiles="@(Binaries)" DestinationFolder="C:\Inetpub\wwwroot\h2g2UnitTesting\dna\BBC.DNA.Dnapages\bin\%(RecursiveDir)" SkipUnchangedFiles="false"  ContinueOnError="false"/>

    <!-- Copy ModerationApi to int drop location -->
    <Copy SourceFiles="@(Skins)" DestinationFolder="C:\Inetpub\wwwroot\h2g2UnitTesting\skins\%(RecursiveDir)" SkipUnchangedFiles="false"  ContinueOnError="false"/>

    <Message Text="Ripley files: @(Ripley)"></Message>

    <Exec Command="delete &quot;C:\Inetpub\wwwroot\h2g2UnitTesting\RipleyServer.old&quot;" Timeout="10000" ContinueOnError="true"></Exec>

    <Exec Command="rename &quot;C:\Inetpub\wwwroot\h2g2UnitTesting\RipleyServer.dll&quot; &quot;C:\Inetpub\wwwroot\h2g2UnitTesting\RipleyServer.old&quot;" Timeout="10000" ContinueOnError="true"></Exec>

    <!-- Copy ripley dlls -->
    <Copy SourceFiles="@(Ripley)" DestinationFolder="C:\Inetpub\wwwroot\h2g2UnitTesting\%(RecursiveDir)" SkipUnchangedFiles="false"  ContinueOnError="true"/>

    <Exec Command="CMD &quot;C:\TFSScripts\UnloadTestWeb.bat&quot;" Timeout="10000"></Exec>

    <!-- run filter.reg -->
    <Exec Command="regedit /s &quot;$(SolutionRoot)\Main\filter.reg&quot;"></Exec>

    <Exec Command="net start &quot;memcached server&quot;" Timeout="10000" ContinueOnError="true"></Exec>

    <!-- start website to copy ripley -->
    <Exec Command="iisweb /start h2g2UnitTesting" Timeout="10000"></Exec>



    <!-- When everything is done, change the status of the task to "Succeeded" -->
    <BuildStep TeamFoundationServerUrl="$(TeamFoundationServerUrl)" BuildUri="$(BuildUri)" Id="$(PostBuildStepId)" Status="Succeeded" Condition=" '$(IsDesktopBuild)' != 'true' " />

    <!-- If an error occurs during the process, run the target "PostBuildStepFailed" -->
    <OnError ExecuteTargets="FailedBeforeTest" />
  </Target>

  <Target Name="FailedBeforeTest">
    <!-- start website to copy ripley -->
    <Exec Command="iisweb /start h2g2UnitTesting" Timeout="10000"></Exec>
    <!-- Change the status of the task to "Failed" -->
    <BuildStep TeamFoundationServerUrl="$(TeamFoundationServerUrl)" BuildUri="$(BuildUri)" Id="$(PostBuildStepId)" Status="Failed" Condition=" '$(IsDesktopBuild)' != 'true' " />
  </Target>
</Project>
